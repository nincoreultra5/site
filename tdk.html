l<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TDK T-Shirt Inventory</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:Arial,sans-serif;margin:0;padding:0;background-color:#f4f4f4;overflow-x:hidden}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#ffffff;padding:20px}
.login-box{background:white;padding:40px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);width:100%;max-width:400px;border:2px solid #667eea}
.login-box h2{text-align:center;margin-bottom:10px;color:#333;font-size:24px}
.login-box .app-tag{text-align:center;color:#667eea;font-size:14px;font-weight:bold;margin-bottom:20px;padding:8px;background-color:#f0f0f0;border-radius:5px}
.login-box input{width:100%;padding:14px;margin:10px 0;border:2px solid #ddd;border-radius:5px;box-sizing:border-box;font-size:16px}
.login-box button{width:100%;padding:14px;background-color:#667eea;color:white;border:none;border-radius:5px;cursor:pointer;font-size:16px;margin-top:10px;font-weight:bold}
.login-box button:hover{background-color:#5568d3}
.error-message{color:red;text-align:center;margin-top:10px;display:none;font-size:14px}

.main-app{display:none;width:100%;max-width:100vw;overflow-x:hidden}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background-color:#333;color:white;font-weight:bold;flex-wrap:wrap;gap:10px}
.header h1{margin:0;font-size:16px;line-height:1.2}
.user-info{font-size:10px;color:#ddd;margin-top:3px}
.switch-container{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.switch{position:relative;display:inline-block;width:90px;height:36px;flex-shrink:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#999;transition:background-color 0.4s;border-radius:36px}
.slider:before{position:absolute;content:"";height:28px;width:28px;background-color:white;transition:transform 0.4s;border-radius:50%;top:4px;left:4px}
.slider.neutral{background-color:#999}
.slider.neutral:before{transform:translateX(27px)}
.slider.out{background-color:#dc3545}
.slider.out:before{transform:translateX(0)}
.slider.in{background-color:#28a745}
.slider.in:before{transform:translateX(54px)}
.switch-label{font-size:11px;font-weight:bold;min-width:45px}
.logout-btn{padding:6px 12px;background-color:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px}
.logout-btn:hover{background-color:#c82333}

.warning-banner{background-color:#fff3cd;color:#856404;padding:12px;margin:10px;border-radius:8px;border-left:4px solid #ffc107;font-weight:bold;text-align:center;display:none;font-size:13px}
.current-stock-display{background-color:#d1ecf1;color:#0c5460;padding:12px;margin:10px;border-radius:8px;border-left:4px solid #17a2b8;font-weight:bold;text-align:center}
.stock-title{font-size:13px;margin-bottom:5px}
.stock-numbers{font-size:16px;color:#155724}
.action-display{margin:10px;padding:10px;background-color:#eee;text-align:center;font-weight:bold;font-size:13px;display:none;border-radius:8px}

.section{padding:12px;background-color:#fff;margin:10px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px}
.section-header h3{margin:0;font-size:15px}
.add-all-btn{padding:8px 14px;background-color:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px}
.add-all-btn:hover{background-color:#0056b3}
.add-all-btn:disabled{background-color:#ccc;cursor:not-allowed}

.size-row,.kids-scroll{display:flex;overflow-x:auto;gap:10px;padding:10px 0;scrollbar-width:thin;-webkit-overflow-scrolling:touch}
.size-item{flex:none;display:flex;flex-direction:column;align-items:center;gap:5px}
.size-btn,.kids-box{width:55px;height:55px;background-color:#999;color:white;border:none;border-radius:6px;cursor:pointer;transition:all 0.3s ease;text-align:center;font-weight:bold;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.size-btn.mode-in,.kids-box.mode-in{background-color:#28a745}
.size-btn.mode-out,.kids-box.mode-out{background-color:#dc3545}
.size-btn:active,.kids-box:active{transform:scale(0.95)}
.qty-input{width:55px;padding:6px;border:2px solid #ccc;border-radius:4px;text-align:center;font-size:14px;flex-shrink:0}
.qty-input:focus{outline:none;border-color:#007bff}

.reason-section{padding:12px;background-color:#fff;margin:10px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);display:none}
.reason-section h3{font-size:15px;margin-top:0}
.reason-section select,.reason-section input{
width:100%;
padding:12px;
border:2px solid #ccc;
border-radius:4px;
margin-top:10px;
font-size:14px;
}

.submit-btn{display:block;width:calc(100% - 20px);max-width:500px;margin:20px auto;padding:14px;background-color:#28a745;color:white;border:none;border-radius:6px;font-size:16px;cursor:pointer;transition:all 0.3s ease;font-weight:bold}
.submit-btn:active:not(:disabled){background-color:#218838;transform:scale(0.98)}
.submit-btn:disabled{background-color:#ccc;cursor:not-allowed;transform:none}

.cart-items{padding:12px;background-color:#fff;margin:10px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.cart-items h3{font-size:15px;margin-top:0}
.cart-items ul{list-style:none;padding:0;margin:0;max-height:300px;overflow-y:auto}
.cart-items li{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background-color:#f9f9f9;margin-bottom:5px;border-radius:4px;gap:10px}
.cart-item-info{flex:1;font-size:13px}
.remove-item{background-color:#dc3545;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;flex-shrink:0}
.remove-item:active{background-color:#c82333}
</style>
</head>
<body>

<div class="login-container" id="login-page">
<div class="login-box">
<h2>TDK Login</h2>
<div class="app-tag">üè¢ TDK Access Only</div>
<form id="login-form">
<input type="text" id="login-username" placeholder="Username" required>
<input type="password" id="login-password" placeholder="Password" required>
<button type="submit">Login</button>
<div class="error-message" id="error-message"></div>
</form>
</div>
</div>

<div class="main-app" id="main-app">
<div class="header">
<div>
<h1>TDK Stock</h1>
<div class="user-info" id="user-info"></div>
</div>
<div class="switch-container">
<span class="switch-label" id="switch-label">SELECT MODE</span>
<label class="switch">
<span class="slider neutral" id="slider" onclick="cycleSwitch()"></span>
</label>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
</div>

<div class="warning-banner" id="warning-banner">
‚ö†Ô∏è Please select IN or OUT mode using the toggle switch above
</div>

<div class="current-stock-display">
<div class="stock-title">üì¶ CURRENT TDK STOCK</div>
<div class="stock-numbers" id="stock-info">Loading...</div>
</div>

<div class="action-display" id="action-display"></div>

<div class="reason-section" id="reason-section">
<h3>OUT Reason</h3>
<select id="reason-select">
<option value="Distribute">Distribute</option>
<option value="VIP Set">VIP Set</option>
<option value="Kids">Kids</option>
<option value="Return to warehouse">Return to warehouse</option>
<option value="Other">Other</option>
</select>
<input id="reason-custom" type="text" placeholder="Custom reason (max 20 words, optional)">
</div>

<div class="section">
<div class="section-header">
<h3>Kids Sizes (26-32)</h3>
<button class="add-all-btn" id="add-kids-btn" onclick="addKidsItems()" disabled>Add to Cart</button>
</div>
<div class="kids-scroll" id="kids-scroll"></div>
</div>

<div class="section">
<div class="section-header">
<h3>Adults Sizes</h3>
<button class="add-all-btn" id="add-adults-btn" onclick="addAdultItems()" disabled>Add to Cart</button>
</div>
<div class="size-row" id="adult-sizes"></div>
</div>

<div class="cart-items">
<h3>üõí Cart</h3>
<ul id="cart-list"></ul>
</div>

<button class="submit-btn" id="submit-btn" onclick="submitCart()" disabled>Select IN/OUT Mode First</button>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const adultsSizes = ['XS','S','M','L','XL','XXL','XXXL'];
const kidsSizes = ['26','28','30','32'];

let currentAction = null;
let switchState = 'neutral';
let cart = [];
let currentUser = null;

let stockChannel = null;
let refreshTimer = null;

const SUPABASE_URL = 'https://csbbclnqxatcpufcgykc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYmJjbG5xeGF0Y3B1ZmNneWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0OTEwMDUsImV4cCI6MjA4MTA2NzAwNX0.cptSdF-WoZzA0SBR5LQLCnkfDGGAo8XKTdJEcLvA_tM';

const ORG = 'TDK';
const ALLOWED_ORGANIZATION = 'TDK';

const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); /* init pattern [web:84] */

document.getElementById('login-form').addEventListener('submit', async (e) => {
e.preventDefault();
const username = document.getElementById('login-username').value.trim();
const password = document.getElementById('login-password').value.trim();
const errorMsg = document.getElementById('error-message');

try {
const { data, error } = await client
.from('users')
.select('id,username,password,name,organization')
.eq('username', username)
.eq('password', password)
.eq('organization', ALLOWED_ORGANIZATION)
.maybeSingle();

if (error) throw error;

if (!data) {
errorMsg.textContent = 'Invalid credentials';
errorMsg.style.display = 'block';
return;
}

currentUser = data;
errorMsg.style.display = 'none';
showMainApp();
} catch (err) {
console.error(err);
errorMsg.textContent = 'Login failed';
errorMsg.style.display = 'block';
}
});

async function showMainApp() {
document.getElementById('login-page').style.display = 'none';
document.getElementById('main-app').style.display = 'block';
document.getElementById('user-info').textContent = `${currentUser.name} (${currentUser.organization})`;
document.getElementById('warning-banner').style.display = 'block';
await loadOrgTotals();
startLiveUpdates();
}

async function loadOrgTotals() {
try {
const { data, error } = await client
.from('stock')
.select('category,quantity')
.eq('organization', ORG);

if (error) throw error;

let totalKids = 0, totalAdults = 0;
(data || []).forEach(item => {
if (item.category === 'kids') totalKids += item.quantity;
if (item.category === 'adults') totalAdults += item.quantity;
});

const grandTotal = totalKids + totalAdults;
document.getElementById('stock-info').innerHTML =
`Kids: <strong>${totalKids}</strong> | Adults: <strong>${totalAdults}</strong> | Total: <strong>${grandTotal}</strong>`;
} catch (err) {
console.error(err);
document.getElementById('stock-info').textContent = 'Error loading stock';
}
}

/* AUTO-REFRESH (Realtime + Polling) */
function startLiveUpdates() {
stopLiveUpdates();

// Realtime changes with filter organization=eq.TDK [web:94]
stockChannel = client
.channel('tdk-stock-changes')
.on(
'postgres_changes',
{ event: '*', schema: 'public', table: 'stock', filter: `organization=eq.${ORG}` },
() => { loadOrgTotals(); }
)
.subscribe((status) => {
if (status === 'SUBSCRIBED') loadOrgTotals();
});

// Backup polling
refreshTimer = setInterval(loadOrgTotals, 2000);
}

function stopLiveUpdates() {
if (refreshTimer) clearInterval(refreshTimer);
refreshTimer = null;

if (stockChannel) {
try { stockChannel.unsubscribe(); } catch (e) {}
client.removeChannel(stockChannel);
}
stockChannel = null;
}

// Mobile/Tab fix
document.addEventListener('visibilitychange', () => {
if (!currentUser) return;
if (document.visibilityState === 'visible') {
loadOrgTotals();
startLiveUpdates();
} else {
stopLiveUpdates();
}
});

function logout() {
stopLiveUpdates();
currentUser = null;
currentAction = null;
switchState = 'neutral';
cart = [];
document.getElementById('login-page').style.display = 'flex';
document.getElementById('main-app').style.display = 'none';
document.getElementById('login-username').value = '';
document.getElementById('login-password').value = '';
resetSwitch();
updateSizeButtonColors();
updateCart();
}

function updateSizeButtonColors() {
const allSizeButtons = document.querySelectorAll('.size-btn, .kids-box');
allSizeButtons.forEach(btn => {
btn.classList.remove('mode-in','mode-out');
if (currentAction === 'in') btn.classList.add('mode-in');
if (currentAction === 'out') btn.classList.add('mode-out');
});
}

function cycleSwitch() {
const slider = document.getElementById('slider');
const label = document.getElementById('switch-label');
const actionDisplay = document.getElementById('action-display');
const warningBanner = document.getElementById('warning-banner');
const submitBtn = document.getElementById('submit-btn');
const addKidsBtn = document.getElementById('add-kids-btn');
const addAdultsBtn = document.getElementById('add-adults-btn');
const reasonSection = document.getElementById('reason-section');

if (switchState === 'neutral') {
switchState = 'out';
currentAction = 'out';
slider.className = 'slider out';
label.textContent = 'OUT';
submitBtn.textContent = 'Submit - Stock OUT';
actionDisplay.textContent = 'üì§ STOCK OUT (TDK)';
actionDisplay.style.backgroundColor = '#f8d7da';
actionDisplay.style.display = 'block';
warningBanner.style.display = 'none';
reasonSection.style.display = 'block';
submitBtn.disabled = false;
addKidsBtn.disabled = false;
addAdultsBtn.disabled = false;
submitBtn.style.backgroundColor = '#dc3545';
} else if (switchState === 'out') {
switchState = 'in';
currentAction = 'in';
slider.className = 'slider in';
label.textContent = 'IN';
submitBtn.textContent = 'Submit - Stock IN';
actionDisplay.textContent = 'üì• STOCK IN (from warehouse)';
actionDisplay.style.backgroundColor = '#d4edda';
actionDisplay.style.display = 'block';
warningBanner.style.display = 'none';
reasonSection.style.display = 'none';
submitBtn.disabled = false;
addKidsBtn.disabled = false;
addAdultsBtn.disabled = false;
submitBtn.style.backgroundColor = '#28a745';
} else {
resetSwitch();
}

updateSizeButtonColors();
}

function resetSwitch() {
switchState = 'neutral';
currentAction = null;
document.getElementById('slider').className = 'slider neutral';
document.getElementById('switch-label').textContent = 'SELECT MODE';
document.getElementById('action-display').style.display = 'none';
document.getElementById('warning-banner').style.display = 'block';
document.getElementById('reason-section').style.display = 'none';
document.getElementById('submit-btn').disabled = true;
document.getElementById('add-kids-btn').disabled = true;
document.getElementById('add-adults-btn').disabled = true;
document.getElementById('submit-btn').textContent = 'Select IN/OUT Mode';
document.getElementById('submit-btn').style.backgroundColor = '#ccc';
}

function createSizeButtons(containerId, sizes, isAdult = true) {
const container = document.getElementById(containerId);
sizes.forEach(size => {
const sizeItem = document.createElement('div');
sizeItem.className = 'size-item';

const btn = document.createElement('button');
btn.className = isAdult ? 'size-btn' : 'kids-box';
btn.textContent = size;

const input = document.createElement('input');
input.type = 'number';
input.className = 'qty-input';
input.placeholder = 'Qty';
input.min = '0';
input.value = '0';
input.dataset.size = size;
input.dataset.category = isAdult ? 'adults' : 'kids';

sizeItem.appendChild(btn);
sizeItem.appendChild(input);
container.appendChild(sizeItem);
});
}

function addKidsItems(){ addItemsFrom('#kids-scroll .qty-input','kids'); }
function addAdultItems(){ addItemsFrom('#adult-sizes .qty-input','adults'); }

function addItemsFrom(selector, category) {
if (!currentAction) { alert('Please select IN or OUT mode first'); return; }
const inputs = document.querySelectorAll(selector);
let added = 0;

inputs.forEach(input => {
const quantity = parseInt(input.value, 10) || 0;
if (quantity > 0) {
cart.push({ category, size: input.dataset.size, quantity, action: currentAction });
input.value = '0';
added++;
}
});

if (added === 0) alert('Please enter quantity for at least one size');
updateCart();
}

function updateCart() {
const list = document.getElementById('cart-list');
list.innerHTML = '';

if (cart.length === 0) {
list.innerHTML = '<li style="text-align:center;color:#999;">Cart is empty</li>';
return;
}

cart.forEach((item, index) => {
const li = document.createElement('li');
li.innerHTML = `
<div class="cart-item-info">
<strong>${item.action.toUpperCase()}</strong> - ${item.category.toUpperCase()}<br>
Size: <strong>${item.size}</strong> | Qty: <strong>${item.quantity}</strong>
</div>
<button class="remove-item" onclick="removeFromCart(${index})">Remove</button>
`;
list.appendChild(li);
});
}

function removeFromCart(index) {
cart.splice(index, 1);
updateCart();
}

function countWords(s) {
return (s.trim().match(/\S+/g) || []).length;
}

function buildOutReason() {
const base = document.getElementById('reason-select').value;
const custom = document.getElementById('reason-custom').value.trim();
if (!custom) return base;
if (countWords(custom) > 20) throw new Error('Custom reason must be max 20 words.');
return `${base}: ${custom}`;
}

async function submitCart() {
if (!currentAction) { alert('Please select IN or OUT mode first'); return; }
if (cart.length === 0) { alert('Cart is empty'); return; }

const totalQty = cart.reduce((sum, x) => sum + x.quantity, 0);

let reason = '';
let outReasonBase = '';

if (currentAction === 'in') {
reason = 'from warehouse';
if (!confirm(`Receive ${totalQty} items (from warehouse)?\n\nThis will INCREASE TDK stock.`)) return;
} else {
try { reason = buildOutReason(); }
catch (e) { alert(e.message); return; }
outReasonBase = document.getElementById('reason-select').value;

const extra = (outReasonBase === 'Return to warehouse')
? '\n\nThis will DECREASE TDK stock and INCREASE Warehouse stock.'
: '\n\nThis will DECREASE TDK stock.';
if (!confirm(`Dispatch ${totalQty} items from TDK?\nReason: ${reason}${extra}`)) return;
}

try {
for (const item of cart) {
if (currentAction === 'in') {
const { error } = await client.rpc('upsert_warehouse_stock', {
p_organization: ORG,
p_category: item.category,
p_size: item.size,
p_quantity: item.quantity,
p_type: 'in',
p_user_name: currentUser.name,
p_reason: reason
});
if (error) throw error;
} else {
if (outReasonBase === 'Return to warehouse') {
const { error } = await client.rpc('move_stock_warehouse_to_org', {
p_from_org: ORG,
p_to_org: 'Warehouse',
p_category: item.category,
p_size: item.size,
p_quantity: item.quantity,
p_user_name: currentUser.name,
p_reason: reason
});
if (error) throw error;
} else {
const { error } = await client.rpc('upsert_warehouse_stock', {
p_organization: ORG,
p_category: item.category,
p_size: item.size,
p_quantity: -item.quantity,
p_type: 'out',
p_user_name: currentUser.name,
p_reason: reason
});
if (error) throw error;
}
}
}

cart = [];
updateCart();
document.getElementById('reason-custom').value = '';
await loadOrgTotals();
alert(`‚úÖ Success! ${totalQty} items processed.`);
} catch (err) {
console.error(err);
alert('Error: ' + (err.message || 'Failed'));
}
}

createSizeButtons('adult-sizes', adultsSizes, true);
createSizeButtons('kids-scroll', kidsSizes, false);
updateCart();
</script>
</body>
</html>
